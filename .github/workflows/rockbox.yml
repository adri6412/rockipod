name: Build Rockbox for FiiO M3K

on:
  push:
    paths:
      - 'apps/**'
      - 'bootloader/**'
      - 'firmware/**'
      - 'tools/**'
      - 'wps/**'
      - 'backdrops/**'
      - '.github/workflows/rockbox.yml'
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Dependencies for Toolchain Build
      run: |
        sudo apt-get update
        # Install deps required by rockboxdev.sh
        sudo apt-get install -y build-essential git zip libsdl1.2-dev flex bison texinfo \
          curl automake libtool libtool-bin autoconf libmpc-dev libgmp-dev libmpfr-dev \
          gawk
        # Note: gcc-mipsel-linux-gnu is NOT needed as we build our own toolchain

    - name: Cache Rockbox Toolchain
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: /opt/mips
        # Key based on rockboxdev.sh content ensures rebuild if script changes
        key: rockbox-toolchain-mips-${{ hashFiles('tools/rockboxdev.sh') }}

    - name: Build Rockbox Toolchain
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        sudo mkdir -p /opt/mips
        sudo chown $USER /opt/mips
        # 'i' is the target for MIPS (Bare Metal) in rockboxdev.sh
        ./tools/rockboxdev.sh --target=i --prefix=/opt/mips --dlwhere=/tmp/rbdev-dl --builddir=/tmp/rbdev-build

    - name: Add Toolchain to PATH
      run: echo "/opt/mips/bin" >> $GITHUB_PATH

    - name: Configure Rockbox
      run: |
        mkdir -p build
        cd build
        ../tools/configure --target=fiiom3k --type=N --ram=0

    - name: Compile Rockbox
      working-directory: build
      run: |
        make -j$(nproc)
        # Ensure rockbox.m3k is created
        ls -l rockbox.m3k

    - name: Assemble Release
      run: |
        mkdir -p release/.rockbox
        
        # 1. Copy Firmware
        cp build/rockbox.m3k release/
        cp build/rockbox-info.txt release/.rockbox/
        
        # 2. Copy Codecs, Plugins, etc. (from build output)
        mkdir -p release/.rockbox/codecs
        find build -name "*.codec" -exec cp {} release/.rockbox/codecs/ \;
        
        mkdir -p release/.rockbox/rocks/apps
        cp -r build/apps/plugins/*.rock release/.rockbox/rocks/apps/ || true
        
        mkdir -p release/.rockbox/fonts
        cp build/fonts/* release/.rockbox/fonts/
        
        mkdir -p release/.rockbox/langs
        cp build/apps/lang/*.lng release/.rockbox/langs/
        
        # 3. Merge iPodLike Theme (Base)
        if [ -d "iPodLike_Fixed/.rockbox" ]; then
          cp -r iPodLike_Fixed/.rockbox/* release/.rockbox/
        else
          echo "Warning: iPodLike_Fixed directory not found"
        fi
        
        # 4. Copy WPS/Themes (Source overlays)
        mkdir -p release/.rockbox/backdrops
        cp backdrops/*.bmp release/.rockbox/backdrops/ || true
        
        mkdir -p release/.rockbox/wps/iPodLike
        cp wps/*.wps release/.rockbox/wps/ || true
        cp wps/*.sbs release/.rockbox/wps/ || true
        cp wps/iPodLike/*.bmp release/.rockbox/wps/iPodLike/ || true
        
        mkdir -p release/.rockbox/themes
        cp -r apps/themes/* release/.rockbox/themes/ || true
        
        # 5. Set default theme config
        cp apps/themes/iPodLike.cfg release/.rockbox/config.cfg || true

        # Create Zip for Release
        cd release
        zip -r ../rockbox-fiiom3k.zip . rockbox.m3k

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: rockbox-fiiom3k
        path: release/

    - name: Release Firmware
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: rockbox-fiiom3k.zip
